<!DOCTYPE html>
<html>
  <head>
    <title>Title</title>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="styles.css">
  </head>
  <body>
    <textarea id="source">

class: middle, centre




# Open source tools for working with data


---




# Introduction


Open source software development for research:


--


  * Efficient format for tabular data


--


  * User-friendly tools for tabular data manipulations


--


  * Plotting facilities for tabular data (esp. grouped data)


--


  * Custom array type to incorporate photometry or recordings in tables


--


  * Toolkit to build web apps following "data flow"


---




# The Julia programming language


--


  * Modern, open-source and free programming language


--


  * Easy to use (interactive console, little "boilerplate") but good performance


--


  * Rich type system and multiple dispatch allow for fast custom data structures


--


  * Metaprogramming: Julia can modify its own code before running it


---




# StructArrays: flexibly switching from row-based to column-based


```julia
using StructArrays
s = StructArray(a=1:3, b=["x", "y", "z"])
s[1] # Behaves like an array of structures
```

```
(a = 1, b = "x")
```


--


```julia
map(row -> exp(row.a), s) # Behaves like an array of structures
```

```
3-element Array{Float64,1}:
  2.718281828459045
  7.38905609893065
 20.085536923187668
```


--


```julia
fieldarrays(s) # Data is stored as columns
```

```
(a = 1:3, b = ["x", "y", "z"])
```


---




# StructArrays: technical highlights


--


  * Arbitrary column array types are supported:

      * distributed arrays for parallel computing on a cluster
      * cuda arrays to run operations on cuda kernels


--


```julia
using CuArrays
a = CuArray(rand(Float32, 10))
b = CuArray(rand(Bool, 10))
StructArray(a = a, b = b)
```


--


  * for immutable structs (`namedtuple` in Python, non-existent in Matlab) of "plain data types" (i.e. no pointers), row iteration does not allocate


--


```julia
a = rand(Float32, 26)
b = rand(Bool, 26)
c = 'a':'z'
s = StructArray(a = a, b = b, c = c)
@btime $s[3]
```

```
  3.902 ns (0 allocations: 0 bytes)
(a = 0.8898519f0, b = false, c = 'c')
```


---




# Working with tabular data


```julia
using JuliaDBMeta
iris = loadtable("/home/pietro/Data/examples/iris.csv")
```

```
Table with 150 rows, 5 columns:
SepalLength  SepalWidth  PetalLength  PetalWidth  Species
─────────────────────────────────────────────────────────────
5.1          3.5         1.4          0.2         "setosa"
4.9          3.0         1.4          0.2         "setosa"
4.7          3.2         1.3          0.2         "setosa"
4.6          3.1         1.5          0.2         "setosa"
5.0          3.6         1.4          0.2         "setosa"
5.4          3.9         1.7          0.4         "setosa"
4.6          3.4         1.4          0.3         "setosa"
5.0          3.4         1.5          0.2         "setosa"
4.4          2.9         1.4          0.2         "setosa"
⋮
5.8          2.7         5.1          1.9         "virginica"
6.8          3.2         5.9          2.3         "virginica"
6.7          3.3         5.7          2.5         "virginica"
6.7          3.0         5.2          2.3         "virginica"
6.3          2.5         5.0          1.9         "virginica"
6.5          3.0         5.2          2.0         "virginica"
6.2          3.4         5.4          2.3         "virginica"
5.9          3.0         5.1          1.8         "virginica"
```


---




# Working with columns


External packages implement normal tabular data operations on `StructArrays` (map, filter, join, groupby, etc...) as well as macros to use symbols as if they were columns:


```julia
@with iris mean(:SepalLength) / mean(:SepalWidth)
```

```
1.9112516354121238
```


--


```julia
@groupby iris :Species (Mean = mean(:SepalLength), STD = std(:SepalWidth))
```

```
Table with 3 rows, 3 columns:
Species       Mean   STD
─────────────────────────────
"setosa"      5.006  0.379064
"versicolor"  5.936  0.313798
"virginica"   6.588  0.322497
```


---




# Working with rows


```julia
@apply iris begin
    @transform (Ratio = :SepalLength / :SepalWidth, Large = :PetalWidth > 2)
    @filter :Ratio > 2 && :Species != "versicolor"
end
```

```
Table with 41 rows, 7 columns:
SepalLength  SepalWidth  PetalLength  PetalWidth  Species      Ratio    Large
─────────────────────────────────────────────────────────────────────────────
5.8          2.7         5.1          1.9         "virginica"  2.14815  false
7.1          3.0         5.9          2.1         "virginica"  2.36667  true
6.3          2.9         5.6          1.8         "virginica"  2.17241  false
6.5          3.0         5.8          2.2         "virginica"  2.16667  true
7.6          3.0         6.6          2.1         "virginica"  2.53333  true
7.3          2.9         6.3          1.8         "virginica"  2.51724  false
6.7          2.5         5.8          1.8         "virginica"  2.68     false
6.5          3.2         5.1          2.0         "virginica"  2.03125  false
6.4          2.7         5.3          1.9         "virginica"  2.37037  false
⋮
6.7          3.1         5.6          2.4         "virginica"  2.16129  true
6.9          3.1         5.1          2.3         "virginica"  2.22581  true
5.8          2.7         5.1          1.9         "virginica"  2.14815  false
6.8          3.2         5.9          2.3         "virginica"  2.125    true
6.7          3.3         5.7          2.5         "virginica"  2.0303   true
6.7          3.0         5.2          2.3         "virginica"  2.23333  true
6.3          2.5         5.0          1.9         "virginica"  2.52     false
6.5          3.0         5.2          2.0         "virginica"  2.16667  false
```


---




# Plotting can be part of the pipeline


```julia
using StatsPlots
@apply iris begin
    @transform (Ratio = :SepalLength/:SepalWidth, Sum = :SepalLength+:SepalWidth)
    @df corrplot([:Ratio :Sum])
end
```


![](../corrplot.svg)


---




# Plotting grouped data


```julia
school = loadtable("/home/pietro/Data/examples/school.csv")
```

```
Table with 7185 rows, 8 columns:
School  Minrty  Sx        SSS     MAch    MeanSES    Sector      CSES
──────────────────────────────────────────────────────────────────────────
1224    "No"    "Female"  -1.528  5.876   -0.434383  "Public"    -1.09362
1224    "No"    "Female"  -0.588  19.708  -0.434383  "Public"    -0.153617
1224    "No"    "Male"    -0.528  20.349  -0.434383  "Public"    -0.093617
1224    "No"    "Male"    -0.668  8.781   -0.434383  "Public"    -0.233617
1224    "No"    "Male"    -0.158  17.898  -0.434383  "Public"    0.276383
1224    "No"    "Male"    0.022   4.583   -0.434383  "Public"    0.456383
1224    "No"    "Female"  -0.618  -2.832  -0.434383  "Public"    -0.183617
1224    "No"    "Male"    -0.998  0.523   -0.434383  "Public"    -0.563617
1224    "No"    "Female"  -0.888  1.527   -0.434383  "Public"    -0.453617
⋮
9586    "No"    "Female"  1.212   15.26   0.621153   "Catholic"  0.590847
9586    "No"    "Female"  1.022   22.78   0.621153   "Catholic"  0.400847
9586    "Yes"   "Female"  1.612   20.967  0.621153   "Catholic"  0.990847
9586    "No"    "Female"  1.512   20.402  0.621153   "Catholic"  0.890847
9586    "No"    "Female"  -0.038  14.794  0.621153   "Catholic"  -0.659153
9586    "No"    "Female"  1.332   19.641  0.621153   "Catholic"  0.710847
9586    "No"    "Female"  -0.008  16.241  0.621153   "Catholic"  -0.629153
9586    "No"    "Female"  0.792   22.733  0.621153   "Catholic"  0.170847
```


---




# Plotting grouped data


```julia
using GroupedErrors
@> school begin
    @splitby _.Sx
    @across _.School
    @x _.MAch
    @y :cumulative
    @plot plot(xlabel = "MAch", ylabel = "CDF")
end
```


![](../cumulative.svg)


---




# Adding neural data to a table: ShiftedArrays


In a typical dataset, recordings and behavior are mismatched:


  * Behavioral data => hundreds of rows (trials)
  * Neural data => hundreds of thousands of frames (photometry)


--


The package ShiftedArrays addresses this issue by creating a custom array type which is a normal array with a shift:


--


```julia
using ShiftedArrays
v = rand(10)
lead(v, 3)
```

```
10-element ShiftedArrays.ShiftedArray{Float64,Missing,1,Array{Float64,1}}:
 0.45571341901489837
 0.003900284651246144
 0.17485462847279454
 0.946964093165531
 0.04760158864717656
 0.06612983849530862
 0.11799511383553463
  missing
  missing
  missing
```


---




# Adding neural data to a table: ShiftedArrays


The underlying data is shared, so creating a `ShiftedArray` is very cheap:


```julia
v = rand(1_000_000)
@benchmark lead($v, 100)
```

```
BenchmarkTools.Trial:
  memory estimate:  32 bytes
  allocs estimate:  1
  --------------
  minimum time:     4.508 ns (0.00% GC)
  median time:      5.522 ns (0.00% GC)
  mean time:        15.741 ns (56.55% GC)
  maximum time:     6.598 μs (99.74% GC)
  --------------
  samples:          10000
  evals/sample:     1000
```


---




# Adding neural data to a table: ShiftedArrays


A new column can be added by simply putting shifted copies of the recordings:


```julia
photometry = rand(100)
timestamps = [12, 23, 48, 97]
shiftedvecs = [lead(photometry, time) for time in timestamps]
ShiftedArrays.to_array(shiftedvecs, -5:5)
```

```
11×4 Array{Union{Missing, Float64},2}:
 0.601581   0.93654    0.335183  0.65376
 0.877581   0.0183839  0.486871  0.965348
 0.602382   0.546612   0.857314  0.858836
 0.364303   0.830641   0.123856  0.0199961
 0.738584   0.291869   0.579806  0.337152
 0.426783   0.581679   0.193602  0.29576
 0.736632   0.714582   0.686344  0.424224
 0.451915   0.0093943  0.219424  0.803821
 0.928053   0.446799   0.283564  0.388626
 0.218848   0.924262   0.150655   missing
 0.0480564  0.952613   0.375851   missing
```


---




# Adding neural data to a table: ShiftedArrays


ShiftedArrays also provides utility function to reduce the data:


```julia
reduce_vec(mean, shiftedvecs, -5:5)
```

```
11-element Array{Float64,1}:
 0.6317662487329192
 0.5870459197597235
 0.716286031907439
 0.33469890097779464
 0.4868523849899755
 0.3744559887131784
 0.6404453512715601
 0.3711383676411991
 0.5117604830854094
 0.43125482807335863
 0.45884013838048804
```


---




# Plotting support provided by GroupedErrors


```julia
@> df begin
    @splitby _.treatment
    @across _.subject
    @x -100:100 :discrete
    @y _.signal
    @plot plot() :ribbon
end
```


![](../photometry.svg)


---




### UI logic


```julia
color = colorpicker()
npoints = slider(10:100, label = "npoints")
markersize = slider(3:10, label = "markersize")
label = textbox("insert legend entry")
plt = Observables.@map scatter(
    rand(&npoints), rand(&npoints),
    color = &color,
    markersize = &markersize,
    label = &label
)
```


--




### Layout:


```julia
ui = vbox(
    color,
    npoints,
    markersize,
    label,
    plt
)
```


---




# Interactive data pipeline


```julia
filename = filepicker()
t = map(loadtable, filename)
filtered_data = selectors(t)
edited_data = data_editor(filtered_data)

spreadsheet =
viewer = dataviewer(edit_data)
```


---




# Future direction: increased UI responsiveness and Interactivity


A newer plotting framework ([Makie](http://juliaplots.org/MakieGallery.jl/stable/index.html) by `@SimonDanisch`: Julia + OpenGL) is compatible with time-varying signals: responsive interfaces where signals are shared between the plot and the UI controls.


--


Disclaimer: I've ported the StatsPlots package to StatsMakie but there is still some quirks to iron out before I can switch to using it exclusively.


---




# Eye catching demos (in house): Makie for whole brain neural activity (cFOS)


<iframe src="../mesh_neurons.mp4" width="640" height="360" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>


Data and classification from Diogo Matias


---




# Combining Makie and Interact


<iframe src="../orbitdiagram.mp4" width="640" height="360" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>


Video Credits: George Datseris and JuliaDynamics organization


---




# References


[StructArrays](https://github.com/piever/StructArrays.jl)


[JuliaDBMeta](https://piever.github.io/JuliaDBMeta.jl/latest/)


[StatsPlots](https://github.com/JuliaPlots/StatsPlots.jl)


[GroupedErrors](https://github.com/piever/GroupedErrors.jl)


[ShiftedArrays](https://github.com/piever/ShiftedArrays.jl)


[Interact](https://github.com/JuliaGizmos/Interact.jl)


[TableWidgets](https://github.com/piever/TableWidgets.jl)


[Makie](http://juliaplots.org/MakieGallery.jl/stable/index.html)

    </textarea>

    <script src="remark.min.js" type="text/javascript"></script>
    <script src="katex.min.js"></script>
    <script src="auto-render.min.js"></script>
    <link rel="stylesheet" href="katex.min.css">
    <script type="text/javascript">
        var options = {};
        var renderMath = function() {
        // renderMathInElement(document.body);
        // or if you want to use $...$ for math,
        renderMathInElement(document.body, {delimiters: [ // mind the order of delimiters(!?)
            {left: "$$", right: "$$", display: true},
            {left: "$", right: "$", display: false},
            {left: "\\[", right: "\\]", display: true},
            {left: "\\(", right: "\\)", display: false},
        ]});
        }

        var slideshow = remark.create({}, renderMath);

        </script>
  </body>
</html>
